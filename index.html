<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canvas LMS - Exam Builder</title>
    
    <!-- FONTS -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700;900&display=swap" rel="stylesheet">
    
    <!-- TAILWIND CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Lato', 'sans-serif'] },
                    colors: {
                        canvas: {
                            nav: '#2D3B45',       // Global Nav Dark
                            primary: '#0374B5',   // Canvas Blue
                            accent: '#F5F5F5',    // Background
                            text: '#2D3B45',
                            border: '#C7CDD1'
                        }
                    },
                    boxShadow: {
                        'card': '0 2px 5px rgba(0,0,0,0.1)',
                    }
                }
            }
        }
    </script>

    <!-- ICONS & LIBS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.8.0/mammoth.browser.min.js"></script>
    
    <style>
        /* UI Utilities */
        .custom-scroll::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #C7CDD1; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #2D3B45; }
        
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .global-nav-item:hover .icon-box { color: #0374B5; background-color: white; }
        
        /* Active Tab Styling */
        .nav-tab-btn.active { 
            background-color: #0374B5; 
            color: white; 
            border-color: #0374B5;
        }

        /* Calendar Grid */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .calendar-day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; border-radius: 4px; font-size: 0.8rem; }
        .calendar-day.today { background-color: #0374B5; color: white; font-weight: bold; }
    </style>
</head>
<body class="bg-[#F5F5F5] text-[#2D3B45] h-screen flex overflow-hidden font-sans">

    <!-- 1. GLOBAL NAVIGATION (Fixed Left Sidebar) -->
    <nav class="w-[84px] bg-canvas-nav flex flex-col items-center py-4 z-50 shrink-0 text-white shadow-xl h-full">
        <div class="mb-6 w-16 h-16 flex items-center justify-center">
            <i class="fas fa-sun text-3xl text-yellow-500 animate-spin-slow"></i> 
        </div>

        <!-- Sidebar Links -->
        <div id="nav-links" class="hidden space-y-4 w-full flex flex-col items-center">
            <button id="nav-btn-dashboard" class="global-nav-item group w-full flex flex-col items-center justify-center py-2 relative">
                <div class="icon-box w-10 h-10 rounded-xl flex items-center justify-center transition-colors duration-200 text-white">
                    <i class="fas fa-tachometer-alt text-2xl"></i>
                </div>
                <span class="text-[10px] mt-1 font-bold group-hover:text-white/80">Dashboard</span>
            </button>

            <button id="nav-btn-courses" class="global-nav-item group w-full flex flex-col items-center justify-center py-2 relative">
                <div class="icon-box w-10 h-10 rounded-xl flex items-center justify-center transition-colors duration-200 text-white">
                    <i class="fas fa-book text-2xl"></i>
                </div>
                <span class="text-[10px] mt-1 font-bold group-hover:text-white/80">Courses</span>
            </button>

            <button id="nav-btn-calendar" class="global-nav-item group w-full flex flex-col items-center justify-center py-2 relative">
                <div class="icon-box w-10 h-10 rounded-xl flex items-center justify-center transition-colors duration-200 text-white">
                    <i class="fas fa-calendar text-2xl"></i>
                </div>
                <span class="text-[10px] mt-1 font-bold group-hover:text-white/80">Calendar</span>
            </button>
        </div>

        <div class="mt-auto mb-4 w-full flex flex-col items-center">
             <button id="btn-logout" class="hidden global-nav-item group w-full flex flex-col items-center justify-center py-2 relative">
                <div class="icon-box w-10 h-10 rounded-xl flex items-center justify-center transition-colors duration-200 text-white bg-red-600/20 group-hover:bg-red-600 group-hover:text-white">
                    <i class="fas fa-sign-out-alt text-xl"></i>
                </div>
                <span class="text-[10px] mt-1 font-bold">Logout</span>
            </button>
        </div>
    </nav>

    <!-- 2. MAIN APP CONTAINER -->
    <div id="app" class="flex-1 flex flex-col h-full overflow-hidden relative">
        
        <!-- HEADER -->
        <header class="bg-white border-b border-canvas-border h-16 flex justify-between items-center px-6 shrink-0 z-30 shadow-sm">
            <div class="flex items-center gap-4">
                <button class="text-canvas-primary md:hidden"><i class="fas fa-bars text-xl"></i></button>
                <div>
                    <h1 class="text-canvas-primary font-bold text-lg tracking-wide">Exam Builder <span class="text-slate-400 font-normal">v5.1</span></h1>
                    <div class="flex items-center gap-2 text-xs text-slate-500">
                        <span id="header-role">User</span>
                        <span>&gt;</span>
                        <span id="header-context">Dashboard</span>
                    </div>
                </div>
            </div>
            <div class="flex items-center gap-3">
                 <button class="bg-canvas-accent text-slate-600 px-3 py-1 rounded border border-canvas-border text-xs font-bold hover:bg-slate-200 transition">
                    <i class="fas fa-glasses mr-1"></i> Student View
                </button>
                 <span class="text-[10px] font-mono font-bold text-green-600 bg-green-50 px-2 py-1 rounded border border-green-200 flex items-center gap-1" id="status-indicator">Local Mode</span>
            </div>
        </header>

        <!-- NOTIFICATIONS -->
        <div id="error-banner" class="hidden bg-red-100 border-l-4 border-red-500 text-red-700 p-4 m-4" role="alert">
            <p class="font-bold">System Alert</p>
            <p id="error-msg">An error occurred.</p>
        </div>

        <!-- CONTENT VIEWS -->
        <div class="flex-1 overflow-hidden flex flex-col relative bg-[#F5F5F5]">
            
            <!-- VIEW: LANDING -->
            <div id="view-landing" class="flex-1 overflow-y-auto custom-scroll p-8 fade-in">
                <h2 class="text-2xl font-light text-slate-700 mb-6 border-b pb-2">Select Portal</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-4xl mx-auto">
                    <!-- Teacher Card -->
                    <button id="nav-teacher" class="bg-white rounded-lg shadow-card overflow-hidden group hover:shadow-lg transition-all text-left h-64 flex flex-col border border-gray-200">
                        <div class="h-32 bg-canvas-nav relative">
                            <div class="absolute inset-0 bg-black/10 group-hover:bg-transparent transition"></div>
                            <div class="absolute bottom-3 left-4 text-white font-bold text-shadow">
                                <i class="fas fa-chalkboard-teacher mr-2"></i> TEACHER PORTAL
                            </div>
                        </div>
                        <div class="p-4 flex-1 flex flex-col justify-between">
                            <div>
                                <h3 class="font-bold text-canvas-primary text-lg group-hover:underline">Instructor Access</h3>
                                <p class="text-xs text-slate-500 mt-1">Manage Curriculum, Questions & Grades</p>
                            </div>
                        </div>
                    </button>

                    <!-- Student Card -->
                    <button id="nav-student" class="bg-white rounded-lg shadow-card overflow-hidden group hover:shadow-lg transition-all text-left h-64 flex flex-col border border-gray-200">
                        <div class="h-32 bg-canvas-primary relative">
                            <div class="absolute inset-0 bg-black/10 group-hover:bg-transparent transition"></div>
                            <div class="absolute bottom-3 left-4 text-white font-bold text-shadow">
                                <i class="fas fa-user-graduate mr-2"></i> STUDENT PORTAL
                            </div>
                        </div>
                        <div class="p-4 flex-1 flex flex-col justify-between">
                            <div>
                                <h3 class="font-bold text-canvas-primary text-lg group-hover:underline">Student Access</h3>
                                <p class="text-xs text-slate-500 mt-1">Take Quizzes & View History</p>
                            </div>
                        </div>
                    </button>
                </div>
            </div>

            <!-- VIEW: TEACHER LOGIN -->
            <div id="view-teacher-login" class="hidden flex-1 flex items-center justify-center p-4 fade-in">
                <div class="max-w-md w-full bg-white shadow-card rounded border border-gray-200 p-8 relative">
                    <button id="close-login" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><i class="fas fa-times"></i></button>
                    <div class="flex flex-col items-center mb-6">
                        <div class="w-16 h-16 bg-canvas-primary rounded-full flex items-center justify-center text-white text-3xl mb-4 shadow-lg">
                            <i class="fas fa-school"></i>
                        </div>
                        <h2 class="text-2xl font-bold text-slate-700">Canvas Login</h2>
                    </div>

                    <div id="form-login">
                        <button id="do-google-login" class="w-full bg-[#4285F4] text-white font-bold py-3 rounded shadow hover:bg-[#357ae8] transition mb-4 flex items-center justify-center gap-3">
                            <i class="fab fa-google bg-white text-[#4285F4] p-1 rounded-full text-xs"></i> Sign in with Google
                        </button>
                        <div class="text-center text-xs text-slate-400 mb-4 border-b border-t py-2 border-slate-100">OR USE CREDENTIALS</div>
                        <div class="space-y-4">
                            <input type="text" id="login-user" class="w-full p-2 border border-gray-300 rounded text-sm focus:border-canvas-primary outline-none" placeholder="Email (Firebase)">
                            <input type="password" id="login-pass" class="w-full p-2 border border-gray-300 rounded text-sm focus:border-canvas-primary outline-none" placeholder="Password">
                        </div>
                        <button id="do-login" class="w-full bg-canvas-nav text-white font-bold py-3 rounded mt-6 hover:bg-slate-800 transition">Log In</button>
                        <div class="text-center mt-4 text-sm">
                            <button id="show-register" class="text-canvas-primary hover:underline">Forgot Password? / Register</button>
                        </div>
                    </div>

                    <div id="form-register" class="hidden">
                        <h3 class="font-bold text-lg mb-4 text-slate-700 border-b pb-2">Create Account</h3>
                        <input type="text" id="reg-name" class="w-full p-2 border border-gray-300 rounded mb-3 text-sm" placeholder="Full Name">
                        <input type="text" id="reg-user" class="w-full p-2 border border-gray-300 rounded mb-3 text-sm" placeholder="Email">
                        <input type="password" id="reg-pass" class="w-full p-2 border border-gray-300 rounded mb-4 text-sm" placeholder="Password">
                        <button id="do-register" class="w-full bg-green-600 text-white font-bold py-2 rounded hover:bg-green-700">Register</button>
                        <button id="cancel-register" class="w-full text-slate-500 text-sm mt-3 hover:text-slate-700">Cancel</button>
                    </div>
                </div>
            </div>

            <!-- VIEW: TEACHER DASHBOARD -->
            <div id="view-dashboard" class="hidden flex-1 flex flex-col overflow-hidden fade-in bg-white h-full">
                
                <!-- HEADER (Dashboard Info) -->
                <div class="bg-white px-8 py-6 border-b border-gray-200 flex flex-col md:flex-row justify-between items-start md:items-end gap-4 shrink-0">
                    <div>
                        <div class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">Current Course</div>
                        <h2 class="text-3xl font-light text-canvas-primary" id="dash-name">Teacher's Course</h2>
                        <div class="text-sm text-slate-500 mt-1" id="dash-details">Loading details...</div>
                    </div>
                    <button id="do-sync" class="bg-slate-100 text-slate-600 px-4 py-2 rounded border border-gray-300 hover:bg-slate-200 text-sm font-bold flex items-center gap-2 transition">
                        <i class="fas fa-cloud text-canvas-primary"></i> <span id="sync-btn-text">Sync Status</span>
                    </button>
                </div>

                <!-- NAVIGATION BAR -->
                <div class="bg-gray-50 border-b border-gray-200 px-8 flex gap-2 overflow-x-auto shrink-0">
                    <button id="tab-btn-students" class="nav-tab-btn active px-5 py-3 text-sm font-bold text-slate-600 border-b-2 border-transparent hover:text-canvas-primary transition-all whitespace-nowrap">Students</button>
                    <button id="tab-btn-curriculum" class="nav-tab-btn px-5 py-3 text-sm font-bold text-slate-600 border-b-2 border-transparent hover:text-canvas-primary transition-all whitespace-nowrap">Curriculum</button>
                    <button id="tab-btn-manage" class="nav-tab-btn px-5 py-3 text-sm font-bold text-slate-600 border-b-2 border-transparent hover:text-canvas-primary transition-all whitespace-nowrap">Assessments</button>
                    <button id="tab-btn-records" class="nav-tab-btn px-5 py-3 text-sm font-bold text-slate-600 border-b-2 border-transparent hover:text-canvas-primary transition-all whitespace-nowrap">Grades & Analytics</button>
                    <button id="tab-btn-settings" class="nav-tab-btn px-5 py-3 text-sm font-bold text-slate-600 border-b-2 border-transparent hover:text-canvas-primary transition-all whitespace-nowrap">Settings</button>
                </div>

                <!-- MAIN SCROLL AREA -->
                <main class="flex-1 overflow-y-auto custom-scroll p-8 bg-white w-full">
                    
                    <!-- 1. STUDENTS TAB -->
                    <div id="tab-students" class="tab-content h-full">
                        <div class="flex justify-between items-end border-b border-gray-300 pb-4 mb-6">
                            <h3 class="text-xl font-bold text-slate-700">Roster</h3>
                            <div class="flex gap-2">
                                <input type="file" id="student-docx-upload" class="hidden" accept=".docx">
                                <button id="do-import-class" class="bg-emerald-600 text-white px-4 py-2 rounded text-sm font-bold hover:bg-emerald-700 shadow-sm"><i class="fas fa-file-import"></i> Import Student List</button>
                                <button id="do-add-student" class="bg-canvas-primary text-white px-4 py-2 rounded text-sm font-bold hover:bg-blue-700 shadow-sm"><i class="fas fa-plus"></i> Add Student</button>
                            </div>
                        </div>
                        
                        <div class="bg-slate-50 p-4 rounded border border-gray-200 mb-6 flex flex-wrap gap-3 items-end shadow-sm">
                            <div class="flex-1 min-w-[200px]">
                                <label class="text-xs font-bold text-slate-600 block mb-1">Student Name</label>
                                <input type="text" id="new-st-name" class="w-full p-2 border border-gray-300 rounded text-sm focus:border-canvas-primary outline-none" placeholder="Full Name">
                            </div>
                            <div class="w-32">
                                <label class="text-xs font-bold text-slate-600 block mb-1">LRN / ID</label>
                                <input type="text" id="new-st-lrn" class="w-full p-2 border border-gray-300 rounded text-sm focus:border-canvas-primary outline-none" placeholder="ID Number">
                            </div>
                            <div class="flex-1 min-w-[200px]">
                                <label class="text-xs font-bold text-slate-600 block mb-1">Section</label>
                                <select id="new-st-course" class="w-full p-2 border border-gray-300 rounded text-sm bg-white"></select>
                            </div>
                        </div>

                        <table class="w-full text-sm text-left border-collapse">
                            <thead class="bg-slate-50 border-b border-gray-300 text-slate-600">
                                <tr>
                                    <th class="p-3 border-r border-gray-200 w-1/3">Name</th>
                                    <th class="p-3 border-r border-gray-200">SIS ID / LRN</th>
                                    <th class="p-3 border-r border-gray-200">Section</th>
                                    <th class="p-3 text-right"></th>
                                </tr>
                            </thead>
                            <tbody id="student-list-body" class="divide-y divide-gray-200"></tbody>
                        </table>
                        <div id="no-students-msg" class="p-8 text-center text-slate-400 bg-slate-50 mt-2 rounded border border-dashed border-gray-300 hidden">No students enrolled.</div>
                    </div>

                    <!-- 2. CURRICULUM TAB -->
                    <div id="tab-curriculum" class="hidden tab-content h-full">
                        <div class="flex justify-between items-end border-b border-gray-300 pb-4 mb-6">
                            <h3 class="text-xl font-bold text-slate-700">Course Structure</h3>
                            <button id="do-add-course" class="bg-canvas-primary text-white px-4 py-2 rounded text-sm font-bold hover:bg-blue-700 shadow-sm"><i class="fas fa-plus"></i> Create Course</button>
                        </div>

                        <div class="bg-slate-50 border border-gray-200 rounded p-4 mb-6 shadow-sm">
                            <h3 class="font-bold text-slate-700 mb-3 text-sm">Structure Builder</h3>
                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-4">
                                <div>
                                    <label class="text-[10px] uppercase font-bold text-slate-500">1. Grade Level</label>
                                    <div class="flex gap-1 mt-1">
                                        <input id="new-grade" class="flex-1 p-2 text-sm border border-gray-300 rounded" placeholder="e.g. Grade 10">
                                        <button id="do-add-grade" class="bg-white border border-gray-300 px-3 rounded hover:bg-slate-100"><i class="fas fa-plus"></i></button>
                                    </div>
                                    <div id="list-grade" class="mt-2 text-xs space-y-1"></div>
                                </div>
                                <div>
                                    <label class="text-[10px] uppercase font-bold text-slate-500">2. Term/Quarter</label>
                                    <select id="cur-grade-select" class="w-full p-2 text-sm border border-gray-300 rounded mt-1 mb-1"></select>
                                    <div class="flex gap-1">
                                        <input id="new-quarter" class="flex-1 p-2 text-sm border border-gray-300 rounded" placeholder="e.g. Q1">
                                        <button id="do-add-quarter" class="bg-white border border-gray-300 px-3 rounded hover:bg-slate-100"><i class="fas fa-plus"></i></button>
                                    </div>
                                    <div id="list-quarter" class="mt-2 text-xs space-y-1"></div>
                                </div>
                                <div>
                                    <label class="text-[10px] uppercase font-bold text-slate-500">3. Subject</label>
                                    <select id="cur-quarter-select" class="w-full p-2 text-sm border border-gray-300 rounded mt-1 mb-1"></select>
                                    <div class="flex gap-1">
                                        <input id="new-subject" class="flex-1 p-2 text-sm border border-gray-300 rounded" placeholder="e.g. Math">
                                        <button id="do-add-subject" class="bg-white border border-gray-300 px-3 rounded hover:bg-slate-100"><i class="fas fa-plus"></i></button>
                                    </div>
                                    <div id="list-subject" class="mt-2 text-xs space-y-1"></div>
                                </div>
                            </div>
                            
                            <div class="border-t border-gray-200 pt-4 mt-2">
                                <label class="text-[10px] uppercase font-bold text-slate-500 mb-2 block">4. Finalize Course Section</label>
                                <div class="flex flex-wrap gap-2 mb-2">
                                    <input id="new-course" class="flex-1 min-w-[200px] p-2 text-sm border border-gray-300 rounded" placeholder="Section Name (e.g. Grade 10 - Newton)">
                                    <input id="new-course-time" type="number" class="w-24 p-2 text-sm border border-gray-300 rounded" placeholder="60 mins">
                                </div>
                                <div id="chk-subjects" class="max-h-32 overflow-y-auto bg-white border border-gray-300 rounded p-2 text-xs grid grid-cols-2 md:grid-cols-4 gap-2"></div>
                            </div>
                        </div>

                        <div id="list-course" class="space-y-4"></div>
                    </div>

                    <!-- 3. QUIZZES TAB -->
                    <div id="tab-manage" class="hidden tab-content h-full flex flex-col">
                        <div class="flex justify-between items-end border-b border-gray-300 pb-4 mb-6">
                            <h3 class="text-xl font-bold text-slate-700">Question Banks</h3>
                            <div class="flex gap-2">
                                <button id="do-get-template" class="bg-white border border-gray-300 text-slate-600 px-3 py-1 rounded text-sm hover:bg-gray-50"><i class="fas fa-download"></i> Template</button>
                                <input type="file" id="docx-upload" class="hidden" accept=".docx">
                                <button onclick="document.getElementById('docx-upload').click()" class="bg-white border border-gray-300 text-slate-600 px-3 py-1 rounded text-sm hover:bg-gray-50"><i class="fas fa-file-import"></i> Import DOCX</button>
                            </div>
                        </div>

                        <div class="bg-slate-50 p-3 border border-gray-200 rounded flex gap-2 mb-4 text-sm shadow-sm">
                            <select id="sel-grade" class="flex-1 p-2 border border-gray-300 rounded bg-white"></select>
                            <select id="sel-quarter" class="flex-1 p-2 border border-gray-300 rounded bg-white"></select>
                            <select id="sel-subject" class="flex-1 p-2 border border-gray-300 rounded bg-white"></select>
                        </div>

                        <div class="flex flex-col lg:flex-row gap-6 flex-1 min-h-0">
                            <!-- Editor -->
                            <div class="w-full lg:w-1/3 flex flex-col">
                                <div class="bg-white border border-gray-300 rounded overflow-hidden flex flex-col h-full shadow-sm">
                                    <div class="bg-gray-50 p-2 border-b border-gray-200 font-bold text-xs text-slate-600">Editor</div>
                                    <div class="p-4 flex-1 overflow-y-auto">
                                        <textarea id="q-text" class="w-full p-3 border border-gray-300 rounded text-sm h-32 mb-3 focus:border-canvas-primary outline-none resize-none" placeholder="Question Text..."></textarea>
                                        <div class="space-y-2 mb-3">
                                            <div class="flex items-center gap-1"><span class="w-6 text-center text-xs font-bold text-slate-500">A</span><input id="opt-a" class="flex-1 p-2 border border-gray-300 rounded text-sm"></div>
                                            <div class="flex items-center gap-1"><span class="w-6 text-center text-xs font-bold text-slate-500">B</span><input id="opt-b" class="flex-1 p-2 border border-gray-300 rounded text-sm"></div>
                                            <div class="flex items-center gap-1"><span class="w-6 text-center text-xs font-bold text-slate-500">C</span><input id="opt-c" class="flex-1 p-2 border border-gray-300 rounded text-sm"></div>
                                            <div class="flex items-center gap-1"><span class="w-6 text-center text-xs font-bold text-slate-500">D</span><input id="opt-d" class="flex-1 p-2 border border-gray-300 rounded text-sm"></div>
                                        </div>
                                        <div class="flex justify-between items-center bg-gray-50 p-2 rounded">
                                            <span class="text-xs font-bold">Correct Answer:</span>
                                            <select id="correct-opt" class="p-1 border border-gray-300 rounded text-sm"><option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option></select>
                                        </div>
                                    </div>
                                    <div class="p-2 border-t border-gray-200">
                                        <button id="do-save-manual" class="w-full bg-canvas-primary text-white py-2 rounded text-sm font-bold hover:bg-blue-700 transition">Save Question</button>
                                    </div>
                                </div>
                            </div>

                            <!-- List -->
                            <div class="flex-1 border border-gray-300 rounded bg-white overflow-hidden flex flex-col shadow-sm">
                                <div class="bg-gray-50 p-2 border-b border-gray-200 font-bold text-xs text-slate-600 flex justify-between">
                                    <span>Questions</span>
                                    <span>Points: 1 each</span>
                                </div>
                                <div id="q-list" class="flex-1 overflow-y-auto p-4 space-y-4"></div>
                                <div id="q-empty" class="flex-1 flex items-center justify-center text-slate-400 text-sm italic">No questions in selected bank.</div>
                            </div>
                        </div>
                    </div>

                    <!-- 4. RECORDS & ANALYTICS TAB -->
                    <div id="tab-records" class="hidden tab-content h-full flex flex-col">
                        <div class="flex justify-between items-end border-b border-gray-300 pb-4 mb-4">
                            <div class="flex gap-4">
                                <button id="btn-view-gradebook" class="text-xl font-bold text-slate-700 border-b-2 border-canvas-primary pb-1">Gradebook</button>
                                <button id="btn-view-analytics" class="text-xl font-bold text-slate-400 hover:text-slate-600 pb-1">Item Analysis</button>
                            </div>
                            <div id="records-filters" class="flex gap-2">
                                <select id="filter-records-grade" class="p-2 border border-gray-300 rounded text-sm bg-white min-w-[200px]" title="Filter by Section"></select>
                            </div>
                        </div>
                        
                        <!-- GRADEBOOK VIEW -->
                        <div id="view-gradebook" class="flex-1 overflow-hidden border border-gray-200 rounded shadow-sm flex flex-col">
                            <div class="overflow-y-auto">
                                <table class="w-full text-sm text-left">
                                    <thead class="bg-slate-50 border-b border-gray-300 text-slate-600 font-bold sticky top-0">
                                        <tr>
                                            <th class="p-3 border-r border-gray-200">Student Name</th>
                                            <th class="p-3 border-r border-gray-200">Grade/Section</th>
                                            <th class="p-3 border-r border-gray-200">Assignment</th>
                                            <th class="p-3 border-r border-gray-200">Score</th>
                                            <th class="p-3 text-right">Date Submitted</th>
                                        </tr>
                                    </thead>
                                    <tbody id="table-records" class="divide-y divide-gray-200"></tbody>
                                </table>
                            </div>
                        </div>

                        <!-- ANALYTICS VIEW -->
                        <div id="view-analytics" class="hidden flex-1 flex flex-col gap-4 overflow-hidden">
                             <div class="flex gap-2 items-center bg-blue-50 p-4 rounded border border-blue-200">
                                <span class="text-sm font-bold text-blue-800">Select Subject for Analysis:</span>
                                <select id="filter-analytics-subject" class="p-2 border border-blue-300 rounded text-sm bg-white min-w-[200px]"></select>
                            </div>
                            <div class="flex-1 overflow-y-auto border border-gray-200 rounded bg-white shadow-sm p-4">
                                <div id="analytics-container" class="space-y-4">
                                    <div class="text-center text-slate-400 italic mt-8">Select a subject to view item analysis.</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 5. SETTINGS TAB -->
                    <div id="tab-settings" class="hidden tab-content h-full max-w-2xl">
                        <h3 class="text-xl font-bold text-slate-700 border-b border-gray-300 pb-4 mb-6">Course Details</h3>
                        
                        <div class="space-y-6">
                            <div>
                                <label class="font-bold text-slate-700 block mb-1">Instructor Name</label>
                                <input id="set-name" type="text" class="w-full p-2 border border-gray-300 rounded text-sm">
                            </div>
                            <div class="flex gap-4">
                                <div class="flex-1">
                                    <label class="font-bold text-slate-700 block mb-1">Grade Level</label>
                                    <input id="set-grade" type="text" class="w-full p-2 border border-gray-300 rounded text-sm">
                                </div>
                                <div class="flex-1">
                                    <label class="font-bold text-slate-700 block mb-1">Subject Area</label>
                                    <input id="set-subject" type="text" class="w-full p-2 border border-gray-300 rounded text-sm">
                                </div>
                            </div>
                            
                            <button id="do-save-profile" class="bg-canvas-primary text-white px-4 py-2 rounded text-sm font-bold hover:bg-blue-700 shadow-sm">Update Details</button>
                            
                            <hr class="border-gray-200 my-4">
                            
                            <div class="bg-red-50 border border-red-200 p-4 rounded">
                                <h4 class="text-red-800 font-bold mb-2">Danger Zone</h4>
                                <p class="text-xs text-red-600 mb-3">Resetting will delete all student data and grades. Content will be preserved.</p>
                                <button id="do-reset-year" class="bg-white border border-red-300 text-red-600 px-3 py-1 rounded text-sm hover:bg-red-50">Reset School Year</button>
                            </div>
                        </div>
                    </div>
                </main>
            </div>

            <!-- VIEW: COURSES (SHARED) -->
            <div id="view-courses" class="hidden flex-1 overflow-y-auto custom-scroll p-8 fade-in">
                <h2 class="text-2xl font-light text-slate-700 mb-6 border-b pb-2" id="courses-title">All Courses</h2>
                <div id="courses-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                <div id="courses-empty" class="text-center text-slate-400 italic mt-12">No courses available.</div>
            </div>

            <!-- VIEW: CALENDAR (SHARED) -->
            <div id="view-calendar" class="hidden flex-1 overflow-y-auto custom-scroll p-8 fade-in">
                <h2 class="text-2xl font-light text-slate-700 mb-6 border-b pb-2">Academic Calendar</h2>
                <div class="flex flex-col lg:flex-row gap-8">
                    <div class="flex-1 bg-white p-6 rounded shadow-card border border-gray-200">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-slate-700 text-lg">Current Month</h3>
                            <span class="text-xs font-bold bg-blue-100 text-blue-600 px-2 py-1 rounded">Today</span>
                        </div>
                        <div class="calendar-grid mb-4 text-center text-xs font-bold text-slate-400 uppercase">
                            <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
                        </div>
                        <div id="calendar-days" class="calendar-grid">
                            <!-- Days generated by JS -->
                        </div>
                    </div>
                    <div class="w-full lg:w-80">
                        <h3 class="font-bold text-slate-700 mb-4">Upcoming Schedule</h3>
                        <div class="space-y-3" id="calendar-events">
                            <!-- Events generated by JS -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEW: STUDENT LOGIN -->
            <div id="view-student-login" class="hidden flex-1 flex items-center justify-center p-4 fade-in">
                <div class="max-w-md w-full bg-white shadow-card rounded border border-gray-200 p-8 text-center relative">
                    <button id="close-student" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><i class="fas fa-times"></i></button>

                    <div class="w-16 h-16 bg-canvas-primary rounded-full flex items-center justify-center text-white text-3xl mb-6 mx-auto shadow-lg">
                        <i class="fas fa-user-graduate"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-slate-700 mb-2">Student Access</h2>
                    <p class="text-slate-500 text-sm mb-6">Enter details to access your dashboard.</p>
                    
                    <input type="text" id="st-name" class="w-full p-3 border border-gray-300 rounded mb-3 text-sm focus:border-canvas-primary outline-none" placeholder="Full Name">
                    <input type="text" id="st-lrn" class="w-full p-3 border border-gray-300 rounded mb-4 text-sm focus:border-canvas-primary outline-none" placeholder="LRN / Student ID">
                    
                    <button id="do-student-login" class="w-full bg-canvas-primary text-white font-bold py-3 rounded hover:bg-blue-700 transition">Log In</button>
                </div>
            </div>

            <!-- VIEW: STUDENT DASHBOARD -->
            <div id="view-student-dashboard" class="hidden flex-1 flex flex-col overflow-hidden fade-in bg-[#F5F5F5]">
                <main class="flex-1 overflow-y-auto custom-scroll p-8 max-w-6xl mx-auto w-full">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-light text-slate-700">My Dashboard</h2>
                        <button id="btn-student-logout" class="text-red-500 hover:text-red-700 font-bold text-sm flex items-center gap-2">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                    </div>

                    <!-- Welcome Card -->
                    <div class="bg-white p-6 rounded shadow-card mb-6 border border-gray-200">
                        <h1 class="text-xl font-bold text-slate-700">Welcome, <span id="dash-st-name" class="text-canvas-primary">Student</span></h1>
                        <p class="text-sm text-slate-500">ID: <span id="dash-st-lrn" class="font-mono">---</span></p>
                    </div>

                    <div class="bg-white p-6 rounded shadow-card border-l-4 border-canvas-primary mb-8 flex flex-col md:flex-row gap-4 items-center">
                        <div class="flex-1">
                            <h3 class="font-bold text-lg text-slate-800 mb-1">To Do</h3>
                            <p class="text-sm text-slate-500">Select an assessment to begin.</p>
                        </div>
                        <div class="flex gap-2 w-full md:w-auto">
                            <select id="st-course" class="flex-1 p-2 border border-gray-300 rounded text-sm bg-white"></select>
                            <button id="do-start-exam" class="bg-canvas-primary text-white px-4 py-2 rounded font-bold hover:bg-blue-700 text-sm whitespace-nowrap shadow-sm">Take Assessment</button>
                        </div>
                    </div>

                    <h3 class="font-bold text-slate-700 text-lg mb-4 border-b pb-2">Recent Grades</h3>
                    <div class="bg-white rounded shadow-card border border-gray-200 overflow-hidden">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-slate-50 border-b border-gray-200 text-slate-600 font-bold">
                                <tr>
                                    <th class="p-4">Subject</th>
                                    <th class="p-4">Score</th>
                                    <th class="p-4">Date</th>
                                    <th class="p-4 text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="student-results-table" class="divide-y divide-gray-200"></tbody>
                        </table>
                        <div id="student-no-results" class="p-6 text-center text-slate-400 italic">No graded items yet.</div>
                    </div>
                </main>
            </div>

            <!-- VIEW: STUDENT REVIEW -->
            <div id="view-student-review" class="hidden flex-1 flex flex-col bg-white fade-in h-full z-50 absolute inset-0">
                <header class="h-16 bg-white border-b border-gray-200 flex justify-between items-center px-6 shrink-0 shadow-sm">
                    <h1 class="font-bold text-lg text-slate-700">Exam Review</h1>
                    <button id="do-close-review" class="bg-slate-100 text-slate-600 px-4 py-1 rounded text-sm font-bold hover:bg-slate-200">Back to Dashboard</button>
                </header>
                <main class="flex-1 overflow-y-auto custom-scroll p-8 bg-white flex justify-center">
                    <div class="max-w-3xl w-full space-y-6" id="review-container">
                        <!-- Review items injected here -->
                    </div>
                </main>
            </div>

            <!-- VIEW: EXAM PORTAL -->
            <div id="view-exam" class="hidden flex-1 flex flex-col bg-white fade-in h-full z-50 absolute inset-0">
                <header class="h-16 bg-white border-b border-gray-200 flex justify-between items-center px-6 shrink-0 shadow-sm">
                    <h1 class="font-bold text-lg text-slate-700">Assessment: <span id="exam-tag" class="font-normal text-slate-500">Subject</span></h1>
                    <div class="flex items-center gap-4">
                        <div class="text-sm text-slate-500">Time: <span id="timer" class="font-bold text-red-600 font-mono text-lg">00:00</span></div>
                        <button id="do-exit-exam" class="text-sm text-canvas-primary hover:underline">Submit Assessment</button>
                    </div>
                </header>
                <main class="flex-1 flex flex-col md:flex-row overflow-hidden">
                    <div class="flex-1 overflow-y-auto custom-scroll p-8 bg-white flex justify-center">
                        <div class="max-w-3xl w-full">
                            <div class="border border-gray-300 rounded mb-6">
                                <div class="bg-slate-100 p-3 border-b border-gray-300 flex justify-between items-center">
                                    <span class="font-bold text-slate-700" id="exam-progress">Question 1</span>
                                    <span class="text-xs text-slate-500">1 pts</span>
                                </div>
                                <div class="p-6">
                                    <div id="exam-passage" class="hidden bg-slate-50 p-4 border-l-4 border-slate-300 mb-4 text-sm font-serif italic text-slate-700 whitespace-pre-line"></div>
                                    <div class="text-lg text-slate-800 mb-6" id="exam-q-text">Loading...</div>
                                    <div class="space-y-3" id="exam-opts">
                                        <!-- Options will be injected here -->
                                    </div>
                                </div>
                            </div>
                            <div class="flex justify-end pt-4 border-t border-gray-200">
                                <button id="do-next-q" class="bg-canvas-primary text-white px-6 py-2 rounded text-sm font-bold hover:bg-blue-700 shadow-sm">Next <i class="fas fa-chevron-right ml-1"></i></button>
                            </div>
                        </div>
                    </div>
                    <div class="w-64 border-l border-gray-200 bg-slate-50 p-4 overflow-y-auto hidden md:block">
                        <h3 class="font-bold text-sm text-slate-700 mb-4">Questions</h3>
                        <div id="question-grid" class="flex flex-wrap gap-2"></div>
                    </div>
                </main>
            </div>

        </div>
    </div>

    <!-- OFFLINE LOGIC MODULE -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, updateProfile, signInWithEmailAndPassword, signInWithPopup, signInAnonymously, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 1. CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyDL-tWmRKlSrJAzC-JoNrjRemjEslnuuLc",
            authDomain: "exambuilder-418f6.firebaseapp.com",
            projectId: "exambuilder-418f6",
            storageBucket: "exambuilder-418f6.firebasestorage.app",
            messagingSenderId: "764710378686",
            appId: "1:764710378686:web:91120b3fbcf795334312ef"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // --- 2. LOCAL STORAGE "DB" ---
        const DB_KEY = 'canvas_lms_db';
        const DEFAULT_DB = {
            profile: { name: "Instructor", grade: "Grade 10", subject: "General" },
            students: [],
            grades: [], 
            quarters: [],
            subjects: [],
            courses: [], 
            questions: [] 
        };

        const state = {
            user: null, 
            db: loadDB(),
            session: null 
        };

        function loadDB() {
            const raw = localStorage.getItem(DB_KEY);
            return raw ? JSON.parse(raw) : JSON.parse(JSON.stringify(DEFAULT_DB));
        }

        // DEBOUNCE UTILITY
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        const debouncedCloudSync = debounce(async () => {
            if(auth.currentUser && state.user?.role === 'teacher') {
                try {
                    await setDoc(doc(db, 'users', auth.currentUser.uid), { data: state.db });
                    console.log("Synced to cloud (Debounced)");
                    // Show saved
                    const indicator = get('status-indicator');
                    if(indicator) {
                        indicator.innerHTML = '<i class="fas fa-check"></i> Saved to Cloud';
                        indicator.className = "text-[10px] font-mono font-bold text-green-600 bg-green-50 px-2 py-1 rounded border border-green-200 flex items-center gap-1";
                    }
                } catch (e) {
                    console.error("Sync error", e);
                }
            }
        }, 1000);

        async function saveDB() {
            localStorage.setItem(DB_KEY, JSON.stringify(state.db));
            debouncedCloudSync();
        }

        // --- 3. UTILS ---
        const get = (id) => document.getElementById(id);
        const on = (id, event, fn) => {
            const el = get(id);
            if(el) el.addEventListener(event, fn);
        };
        const show = (id) => get(id)?.classList.remove('hidden');
        const hide = (id) => get(id)?.classList.add('hidden');
        const setTxt = (id, txt) => { const el = get(id); if(el) el.innerText = txt; };

        // --- 4. NAVIGATION & VIEWS ---
        const views = ['view-landing', 'view-teacher-login', 'view-student-login', 'view-dashboard', 'view-student-dashboard', 'view-exam', 'view-courses', 'view-calendar', 'view-student-review'];

        function setView(viewId) {
            views.forEach(v => hide(v));
            show(viewId);
            
            // Sidebar handling
            if (viewId === 'view-dashboard' || viewId === 'view-courses' || viewId === 'view-calendar') {
                show('nav-links');
                show('btn-logout');
            } else if (viewId.includes('login') || viewId === 'view-landing') {
                hide('nav-links');
                hide('btn-logout');
            }
        }

        // Global Nav
        on('nav-btn-dashboard', 'click', () => {
            if(state.user?.role === 'teacher') setView('view-dashboard');
            else if(state.user?.role === 'student') setView('view-student-dashboard');
        });
        on('nav-btn-courses', 'click', () => { renderCoursesView(); setView('view-courses'); });
        on('nav-btn-calendar', 'click', () => { renderCalendar(); setView('view-calendar'); });
        on('btn-logout', 'click', () => {
            state.user = null;
            if (snapshotUnsub) snapshotUnsub(); // Clean listener
            signOut(auth);
            setView('view-landing');
        });

        // Portal Selection
        on('nav-teacher', 'click', () => setView('view-teacher-login'));
        on('nav-student', 'click', () => setView('view-student-login'));
        on('close-login', 'click', () => setView('view-landing'));
        on('close-student', 'click', () => setView('view-landing'));
        on('do-close-review', 'click', () => setView('view-student-dashboard'));

        // --- 5. AUTH (FIREBASE) ---
        let snapshotUnsub = null;

        // Listen for auth state
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // Determine if this is a teacher login (usually email/google) vs student anonymous
                if (!user.isAnonymous) {
                    // Logged In Teacher
                    console.log("Logged in Teacher:", user.email);
                    state.user = { role: 'teacher', name: user.displayName || user.email };
                    setTxt('header-role', state.user.name);
                    
                    const ind = get('status-indicator');
                    if(ind) {
                        ind.innerHTML = '<i class="fas fa-cloud"></i> Cloud Connected';
                        ind.className = "text-[10px] font-mono font-bold text-blue-600 bg-blue-50 px-2 py-1 rounded border border-blue-200 flex items-center gap-1";
                    }

                    if (snapshotUnsub) snapshotUnsub();
                    
                    // Specific path: /artifacts/{appId}/users/{uid}/data/main
                    // We must use 'artifacts' path as per system instructions
                    // Note: previous 'doc(db, 'users', user.uid)' was root level which violates rules
                    // Correcting to artifacts path
                    const appId = "exam-builder-v5"; 
                    
                    snapshotUnsub = onSnapshot(doc(db, 'artifacts', appId, 'users', user.uid), (docSnap) => {
                         // We are storing data in a field 'data' or similar. 
                         // To match previous 'doc(db, 'users', user.uid)' logic, we assume user data is in this doc.
                        if (docSnap.exists()) {
                            const cloudData = docSnap.data().data;
                            if(cloudData && JSON.stringify(cloudData) !== JSON.stringify(state.db)) {
                                state.db = cloudData;
                                localStorage.setItem(DB_KEY, JSON.stringify(state.db)); 
                                // console.log("Realtime Sync: UI Updated");
                                updateUI(); 
                            }
                        }
                    });

                    renderDashboard();
                    setView('view-dashboard');
                } else {
                    // Anonymous user (likely student after do-student-login)
                    console.log("Anonymous session active");
                }
            } else {
                console.log("Logged out");
                if (snapshotUnsub) snapshotUnsub();
                const ind = get('status-indicator');
                if(ind) {
                    ind.innerHTML = 'Local Mode';
                    ind.className = "text-[10px] font-mono font-bold text-green-600 bg-green-50 px-2 py-1 rounded border border-green-200 flex items-center gap-1";
                }
            }
        });

        // Helper to refresh current view
        function updateUI() {
            const activeView = views.find(v => !get(v).classList.contains('hidden'));
            
            if (activeView === 'view-dashboard') {
                renderDashboard(); 
                if(get('tab-btn-students').classList.contains('active')) renderStudentList();
                if(get('tab-btn-curriculum').classList.contains('active')) renderStructure();
                if(get('tab-btn-manage').classList.contains('active')) updateSelects(); 
                if(get('tab-btn-records').classList.contains('active')) renderRecords();
            } else if (activeView === 'view-courses') {
                renderCoursesView();
            } else if (activeView === 'view-calendar') {
                renderCalendar();
            } else if (activeView === 'view-student-dashboard') {
                renderStudentDashboard();
            }
            
            const indicator = get('status-indicator');
            if(indicator && indicator.innerText.includes('Cloud')) {
                const originalText = indicator.innerHTML;
                indicator.innerHTML = '<i class="fas fa-sync fa-spin"></i> Syncing...';
                setTimeout(() => indicator.innerHTML = originalText, 500);
            }
        }

        // Email/Pass Login
        on('do-login', 'click', () => {
            const email = get('login-user').value;
            const pass = get('login-pass').value;
            signInWithEmailAndPassword(auth, email, pass)
                .catch(error => {
                     let msg = "Login Failed: " + error.message;
                     if(error.code === 'auth/wrong-password') msg = "Incorrect password.";
                     if(error.code === 'auth/user-not-found') msg = "No user found with this email.";
                     alert(msg);
                });
        });

        // Google Login
        on('do-google-login', 'click', () => {
            const provider = new GoogleAuthProvider();
            signInWithPopup(auth, provider)
                .catch(error => alert("Google Sign-In Error: " + error.message));
        });

        // Register UI Toggles
        on('show-register', 'click', () => { hide('form-login'); show('form-register'); });
        on('cancel-register', 'click', () => { hide('form-register'); show('form-login'); });

        // Register Action
        on('do-register', 'click', async () => {
            const email = get('reg-user').value;
            const pass = get('reg-pass').value;
            const name = get('reg-name').value;
            
            if(!email || !pass) return alert("Please enter email and password");

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, pass);
                if(name) {
                    await updateProfile(userCredential.user, { displayName: name });
                }
                alert("Account created! Logging in...");
            } catch (error) {
                if(error.code === 'auth/operation-not-allowed') {
                    alert("Registration Failed: Please enable 'Email/Password' in Firebase Console -> Authentication -> Sign-in method.");
                } else {
                    alert("Registration Failed: " + error.message);
                }
            }
        });

        // Student Login (Global Cloud Lookup)
        const APP_ID = "exam-builder-v5";

        on('do-student-login', 'click', async () => {
            const name = get('st-name').value;
            const lrn = get('st-lrn').value;
            if(!name || !lrn) return alert("Please enter Name and ID");

            try {
                if (!auth.currentUser) await signInAnonymously(auth);

                // Use corrected path: artifacts/{appId}/public/data/students/{lrn}
                const studentSnap = await getDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'students', lrn));
                
                if (studentSnap.exists()) {
                    const sData = studentSnap.data();
                    if (sData.name.toLowerCase().trim() === name.toLowerCase().trim()) {
                        const teacherSnap = await getDoc(doc(db, 'artifacts', APP_ID, 'users', sData.teacherUid));
                        if(teacherSnap.exists()) {
                            state.db = teacherSnap.data().data; 
                            
                            state.user = { role: 'student', name: sData.name, lrn: sData.lrn, course: sData.course, teacherUid: sData.teacherUid };
                            setTxt('dash-st-name', state.user.name);
                            setTxt('dash-st-lrn', state.user.lrn);
                            
                            renderStudentDashboard();
                            setView('view-student-dashboard');
                            
                            if(snapshotUnsub) snapshotUnsub();
                            snapshotUnsub = onSnapshot(doc(db, 'artifacts', APP_ID, 'users', sData.teacherUid), (docSnap) => {
                                 if (docSnap.exists()) {
                                    state.db = docSnap.data().data;
                                    updateUI();
                                 }
                            });
                            return;
                        }
                    } else {
                        alert("Student found, but name does not match records.");
                        return;
                    }
                } else {
                    // Fallback to local
                    const existing = state.db.students.find(s => s.lrn === lrn);
                    if(existing) {
                        state.user = { role: 'student', name: existing.name, lrn: existing.lrn, course: existing.course };
                        setTxt('dash-st-name', state.user.name);
                        setTxt('dash-st-lrn', state.user.lrn);
                        renderStudentDashboard();
                        setView('view-student-dashboard');
                        return;
                    }
                }
                alert("Student not found in system. Ask instructor to register you.");
            } catch (e) {
                console.error("Student login error", e);
                // Graceful failure: Try local if cloud fails
                const existing = state.db.students.find(s => s.lrn === lrn);
                if(existing) {
                    state.user = { role: 'student', name: existing.name, lrn: existing.lrn, course: existing.course };
                    renderStudentDashboard();
                    setView('view-student-dashboard');
                    return;
                }

                if (e.code === 'auth/admin-restricted-operation' || e.code === 'auth/operation-not-allowed') {
                   // silent fallback above handles this
                } else {
                    alert("Login Error: " + e.message);
                }
            }
        });

        on('btn-student-logout', 'click', () => {
            if(confirm("Log out?")) {
                state.user = null;
                if(snapshotUnsub) snapshotUnsub();
                signOut(auth);
                setView('view-landing');
            }
        });

        // --- 6. TEACHER DASHBOARD LOGIC ---
        
        // Tabs
        const tabs = ['students', 'curriculum', 'manage', 'records', 'settings'];
        tabs.forEach(t => {
            on(`tab-btn-${t}`, 'click', (e) => {
                tabs.forEach(tb => {
                    hide(`tab-${tb}`);
                    get(`tab-btn-${tb}`).classList.remove('active');
                });
                show(`tab-${t}`);
                e.target.classList.add('active');
                if(t === 'records') renderRecords();
            });
        });

        function renderDashboard() {
            setTxt('dash-name', state.db.profile.name + "'s Course");
            setTxt('dash-details', `${state.db.profile.grade} | ${state.db.profile.subject}`);
            get('set-name').value = state.db.profile.name;
            get('set-grade').value = state.db.profile.grade;
            get('set-subject').value = state.db.profile.subject;
            renderStudentList();
            renderStructure();
            updateSelects();
        }

        // A. STUDENTS
        on('do-add-student', 'click', async () => {
            const name = get('new-st-name').value;
            const lrn = get('new-st-lrn').value;
            const course = get('new-st-course').value;
            
            if(name && lrn && course) {
                state.db.students.push({ name, lrn, course });
                
                // IMMEDIATE UI
                renderStudentList();
                get('new-st-name').value = '';
                get('new-st-lrn').value = '';
                
                saveDB(); // Background

                if (auth.currentUser) {
                    try {
                        // Secure Path: artifacts/{appId}/public/data/students/{lrn}
                        await setDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'students', lrn), {
                            name, 
                            lrn, 
                            course, 
                            teacherUid: auth.currentUser.uid 
                        });
                        console.log("Student registered globally");
                    } catch(e) {
                        console.error("Global reg error", e);
                    }
                }
            }
        });

        // --- BATCH IMPORT LOGIC ---
        const batchStudents = [
            { name: "Ayesha Athela Andales", lrn: "128174140084" },
            { name: "Saide", lrn: "123" },
            { name: "Hanneschutz Odchigue", lrn: "401015160073" },
            { name: "Missy Maquiling", lrn: "407917160027" },
            { name: "Nethanyah Jainani", lrn: "102066150203" },
            { name: "Nicole Clair Ladavac", lrn: "127533160044" },
            { name: "Shawn Edrei Sedeo", lrn: "128164130639" },
            { name: "Sheinna Alexa May Aquit", lrn: "128185150086" },
            { name: "Xiarrah Miel Leonardo", lrn: "407917160028" }
        ];

        on('do-import-class', 'click', async () => {
            if(!auth.currentUser) return alert("You must be logged in to sync with Firebase.");
            
            // Validate Section Selection
            const selectedSection = get('new-st-course').value;
            if(!selectedSection) return alert("Please create and select a section from the dropdown below before importing.");

            if(confirm(`Import default student list into "${selectedSection}"? This will add students to your roster and register them for login.`)) {
                let count = 0;
                for (const s of batchStudents) {
                    // Avoid duplicates in local list
                    if(!state.db.students.find(st => st.lrn === s.lrn)) {
                        state.db.students.push({ ...s, course: selectedSection });
                        count++;
                    }
                    // Always try to register globally (in case they exist locally but not in cloud)
                    try {
                        await setDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'students', s.lrn), {
                            name: s.name, 
                            lrn: s.lrn, 
                            course: selectedSection, 
                            teacherUid: auth.currentUser.uid 
                        });
                    } catch(e) { console.error("Import error", e); }
                }
                
                renderStudentList();
                await saveDB();
                alert(`Imported/Updated ${count} students successfully into ${selectedSection}.`);
            }
        });

        function renderStudentList() {
            const tbody = get('student-list-body');
            tbody.innerHTML = '';
            
            if(state.db.students.length === 0) show('no-students-msg');
            else hide('no-students-msg');

            const frag = document.createDocumentFragment();
            state.db.students.forEach((s, i) => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-50";
                tr.innerHTML = `
                        <td class="p-3 border-r border-gray-200">${s.name}</td>
                        <td class="p-3 border-r border-gray-200 font-mono text-xs">${s.lrn}</td>
                        <td class="p-3 border-r border-gray-200">${s.course}</td>
                        <td class="p-3 text-right">
                            <button class="text-red-500 hover:text-red-700 btn-del-student"><i class="fas fa-trash"></i></button>
                        </td>
                `;
                tr.querySelector('.btn-del-student').addEventListener('click', () => delStudent(i));
                frag.appendChild(tr);
            });
            tbody.appendChild(frag);
        }
        
        async function delStudent(i) {
            if(confirm('Remove student?')) {
                const student = state.db.students[i];
                state.db.students.splice(i, 1);
                renderStudentList();
                saveDB();
                
                try {
                    await deleteDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'students', student.lrn));
                } catch(e) { console.error(e); }
            }
        };

        // B. CURRICULUM
        on('do-add-grade', 'click', () => addItem('list-grade', 'new-grade', 'grades'));
        on('do-add-quarter', 'click', () => addItem('list-quarter', 'new-quarter', 'quarters'));
        on('do-add-subject', 'click', () => addItem('list-subject', 'new-subject', 'subjects'));

        async function addItem(listId, inputId, arrayName) {
            const val = get(inputId).value;
            if(val) {
                state.db[arrayName] = state.db[arrayName] || [];
                if(!state.db[arrayName].includes(val)) {
                    state.db[arrayName].push(val);
                    renderStructure();
                    updateSelects();
                    get(inputId).value = '';
                    saveDB();
                }
            }
        }

        async function delItem(arrayName, index) {
            if(confirm("Remove item?")) {
                state.db[arrayName].splice(index, 1);
                renderStructure();
                updateSelects();
                saveDB();
            }
        }

        function renderStructure() {
            ['grade','quarter','subject'].forEach(key => {
                const list = get(`list-${key}`);
                const arr = state.db[key+'s'] || [];
                list.innerHTML = '';
                const frag = document.createDocumentFragment();
                arr.forEach((item, index) => {
                    const div = document.createElement('div');
                    div.className = "bg-gray-100 px-2 py-1 rounded flex justify-between items-center mb-1";
                    div.innerHTML = `
                        <span class="text-sm font-medium text-slate-700">${item}</span>
                        <button class="text-red-400 hover:text-red-600 w-6 h-6 flex items-center justify-center btn-del"><i class="fas fa-trash text-xs"></i></button>
                    `;
                    div.querySelector('.btn-del').addEventListener('click', () => delItem(key+'s', index));
                    frag.appendChild(div);
                });
                list.appendChild(frag);

                if(key !== 'subject') {
                    const sel = get(`cur-${key}-select`);
                    if(sel) sel.innerHTML = arr.map(i => `<option value="${i}">${i}</option>`).join('');
                }
            });

            const chk = get('chk-subjects');
            const subs = state.db.subjects || [];
            chk.innerHTML = subs.map(s => `
                <label class="flex items-center gap-1 cursor-pointer">
                    <input type="checkbox" value="${s}" name="course-subs"> ${s}
                </label>
            `).join('');

            const cList = get('list-course');
            cList.innerHTML = '';
            const fragC = document.createDocumentFragment();
            state.db.courses.forEach((c, i) => {
                const div = document.createElement('div');
                div.className = "bg-white border border-gray-200 p-3 rounded flex justify-between items-center shadow-sm";
                div.innerHTML = `
                        <div>
                            <div class="font-bold text-slate-700">${c.name}</div>
                            <div class="text-xs text-slate-500">${c.grade} | ${c.quarter} | ${c.subjects.join(', ')}</div>
                        </div>
                        <button class="text-red-400 hover:text-red-600 btn-del-course"><i class="fas fa-trash"></i></button>
                `;
                div.querySelector('.btn-del-course').addEventListener('click', () => delCourse(i));
                fragC.appendChild(div);
            });
            cList.appendChild(fragC);
        }

        on('do-add-course', 'click', async () => {
            const name = get('new-course').value;
            const grade = get('cur-grade-select').value;
            const quarter = get('cur-quarter-select').value;
            const subs = Array.from(document.querySelectorAll('input[name="course-subs"]:checked')).map(c => c.value);
            
            if(name && grade && quarter && subs.length > 0) {
                state.db.courses.push({ name, grade, quarter, subjects: subs, time: get('new-course-time').value || 60 });
                renderStructure();
                updateSelects();
                get('new-course').value = '';
                saveDB();
            } else {
                alert("Please fill all fields and select at least one subject.");
            }
        });

        async function delCourse(i) {
            if(confirm("Delete this section?")) {
                state.db.courses.splice(i, 1);
                renderStructure();
                updateSelects();
                saveDB();
            }
        };

        // C. QUESTIONS
        function updateSelects() {
            const grades = state.db.grades || [];
            const qtrs = state.db.quarters || [];
            const subs = state.db.subjects || [];
            const courses = state.db.courses || [];

            const fill = (id, arr) => {
                const el = get(id);
                if(el) el.innerHTML = arr.map(i => `<option value="${i}">${i}</option>`).join('');
            };
            
            fill('sel-grade', grades);
            fill('sel-quarter', qtrs);
            fill('sel-subject', subs);
            fill('new-st-course', courses.map(c => c.name));
            fill('filter-records-grade', courses.map(c => c.name));
            fill('filter-analytics-subject', subs);
            
            // Student Dropdown: Show subjects linked to student's section AND have questions AND not taken yet
            const stCourse = state.user?.course;
            const section = state.db.courses.find(c => c.name === stCourse);
            const btnStart = get('do-start-exam');

            if (state.user?.role === 'student') {
                if (section) {
                    const validSubjects = section.subjects.filter(subj => {
                        // 1. Must have questions created by teacher
                        const hasQuestions = state.db.questions.some(q => 
                            q.subject === subj && 
                            q.grade === section.grade && 
                            q.quarter === section.quarter
                        );

                        // 2. Must NOT be already taken by this student
                        const alreadyTaken = state.db.grades.some(g => 
                            g.studentId === state.user.lrn && 
                            g.subject === subj
                        );

                        return hasQuestions && !alreadyTaken;
                    });

                    if (validSubjects.length > 0) {
                        fill('st-course', validSubjects);
                        if(btnStart) {
                            btnStart.disabled = false;
                            btnStart.classList.remove('opacity-50', 'cursor-not-allowed');
                            btnStart.innerHTML = 'Take Assessment';
                        }
                    } else {
                        get('st-course').innerHTML = '<option>No pending exams</option>';
                        if(btnStart) {
                            btnStart.disabled = true;
                            btnStart.classList.add('opacity-50', 'cursor-not-allowed');
                            btnStart.innerHTML = 'All Done!';
                        }
                    }
                } else {
                     // Fallback if section doesn't exist anymore
                     get('st-course').innerHTML = '<option>Section data missing</option>';
                     if(btnStart) btnStart.disabled = true;
                }
            } else {
                 // Teacher View / Fallback
                 fill('st-course', subs); 
                 if(btnStart) {
                    btnStart.disabled = false;
                    btnStart.classList.remove('opacity-50', 'cursor-not-allowed');
                    btnStart.innerHTML = 'Take Assessment (Preview)';
                 }
            }

            renderQuestions();
        }

        ['sel-grade', 'sel-quarter', 'sel-subject'].forEach(id => on(id, 'change', renderQuestions));

        on('do-save-manual', 'click', async () => {
            const text = get('q-text').value;
            if(!text) return;
            
            const q = {
                id: Date.now().toString(),
                text: text,
                opts: {
                    A: get('opt-a').value,
                    B: get('opt-b').value,
                    C: get('opt-c').value,
                    D: get('opt-d').value
                },
                correct: get('correct-opt').value,
                grade: get('sel-grade').value,
                quarter: get('sel-quarter').value,
                subject: get('sel-subject').value
            };
            
            state.db.questions.push(q);
            renderQuestions();
            get('q-text').value = '';
            ['a','b','c','d'].forEach(x => get('opt-'+x).value = '');
            saveDB();
        });

        function renderQuestions() {
            const g = get('sel-grade').value;
            const q = get('sel-quarter').value;
            const s = get('sel-subject').value;

            const filtered = state.db.questions.filter(qi => qi.grade === g && qi.quarter === q && qi.subject === s);
            const list = get('q-list');
            list.innerHTML = '';

            if(filtered.length === 0) show('q-empty');
            else hide('q-empty');

            const frag = document.createDocumentFragment();
            filtered.forEach(item => {
                const div = document.createElement('div');
                div.className = "p-3 border border-gray-200 rounded text-sm relative group hover:bg-slate-50";
                div.innerHTML = `
                        <div class="font-bold text-slate-700 mb-1 pr-6">${item.text}</div>
                        <div class="grid grid-cols-2 gap-x-4 text-xs text-slate-500">
                            <span class="${item.correct==='A'?'text-green-600 font-bold':''}">A: ${item.opts.A}</span>
                            <span class="${item.correct==='B'?'text-green-600 font-bold':''}">B: ${item.opts.B}</span>
                            <span class="${item.correct==='C'?'text-green-600 font-bold':''}">C: ${item.opts.C}</span>
                            <span class="${item.correct==='D'?'text-green-600 font-bold':''}">D: ${item.opts.D}</span>
                        </div>
                        <button class="absolute top-2 right-2 text-gray-300 hover:text-red-500 btn-del-q"><i class="fas fa-times"></i></button>
                `;
                div.querySelector('.btn-del-q').addEventListener('click', () => delQuestion(item.id));
                frag.appendChild(div);
            });
            list.appendChild(frag);
        }
        
        async function delQuestion(id) {
            state.db.questions = state.db.questions.filter(q => q.id !== id);
            renderQuestions();
            saveDB();
        };

        // --- IMPORT/EXPORT ---
        on('do-get-template', 'click', () => {
            const template = `For items 1-5:\nMany people believe...\n\n1. What is the main idea?\nA. Option 1\nB. Option 2\nC. Option 3\nD. Option 4\nAnswer: B`;
            const blob = new window.Blob([template], { type: 'text/plain' });
            const anchor = document.createElement('a');
            anchor.href = window.URL.createObjectURL(blob);
            anchor.download = 'exam_template.txt'; 
            anchor.click();
        });

        on('docx-upload', 'change', (e) => {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(loadEvent) {
                const arrayBuffer = loadEvent.target.result;
                mammoth.extractRawText({arrayBuffer: arrayBuffer})
                    .then(displayResult)
                    .catch(handleError);
            };
            reader.readAsArrayBuffer(file);
        });

        async function displayResult(result) {
            const text = result.value;
            const questions = parseQuestions(text);
            if(questions.length > 0) {
                state.db.questions.push(...questions);
                renderQuestions();
                alert(`Successfully imported ${questions.length} questions!`);
                saveDB();
            } else {
                alert("No valid questions found.");
            }
        }

        function handleError(err) { console.error(err); alert("Error reading file."); }

        function parseQuestions(text) {
            const lines = text.split('\n').map(l => l.trim()).filter(l => l);
            const parsed = [];
            let currentQ = null;
            let currentPassage = "";
            let capturingPassage = false;

            const isPassageStart = (l) => /^For item/i.test(l) || /^Passage:/i.test(l);
            const isQuestionStart = (l) => /^\d+[\.\)]/.test(l); 
            const isOption = (l) => /^[A-D][\.\)]/.test(l);
            const isAnswer = (l) => /^Answer:/i.test(l);

            lines.forEach(line => {
                if (isPassageStart(line)) {
                    capturingPassage = true;
                    currentPassage = line + "\n";
                } else if (isQuestionStart(line)) {
                    if (currentQ) parsed.push(currentQ);
                    capturingPassage = false; 
                    currentQ = {
                        id: Date.now() + Math.random().toString(),
                        text: line.replace(/^\d+[\.\)]\s*/, ''),
                        opts: { A:'', B:'', C:'', D:'' },
                        correct: 'A',
                        grade: get('sel-grade').value,
                        quarter: get('sel-quarter').value,
                        subject: get('sel-subject').value,
                        passage: currentPassage.trim()
                    };
                } else if (isOption(line) && currentQ) {
                    const char = line.charAt(0).toUpperCase();
                    currentQ.opts[char] = line.substring(2).trim();
                } else if (isAnswer(line) && currentQ) {
                    currentQ.correct = line.split(':')[1].trim().toUpperCase().charAt(0);
                } else if (capturingPassage) {
                    currentPassage += line + "\n";
                }
            });
            if (currentQ) parsed.push(currentQ);
            return parsed;
        }

        // D. RECORDS
        on('btn-view-gradebook', 'click', () => {
            show('view-gradebook'); hide('view-analytics');
            get('btn-view-gradebook').classList.replace('text-slate-400', 'text-slate-700');
            get('btn-view-gradebook').classList.add('border-b-2', 'border-canvas-primary');
            get('btn-view-analytics').classList.replace('text-slate-700', 'text-slate-400');
            get('btn-view-analytics').classList.remove('border-b-2', 'border-canvas-primary');
        });
        on('btn-view-analytics', 'click', () => {
            hide('view-gradebook'); show('view-analytics');
            get('btn-view-analytics').classList.replace('text-slate-400', 'text-slate-700');
            get('btn-view-analytics').classList.add('border-b-2', 'border-canvas-primary');
            get('btn-view-gradebook').classList.replace('text-slate-700', 'text-slate-400');
            get('btn-view-gradebook').classList.remove('border-b-2', 'border-canvas-primary');
        });

        function renderRecords() {
            const filter = get('filter-records-grade').value; 
            const tbody = get('table-records');
            tbody.innerHTML = '';
            
            const studentsInSection = state.db.students.filter(s => s.course === filter).map(s => s.lrn);
            const records = state.db.grades.filter(g => studentsInSection.includes(g.studentId));

            const frag = document.createDocumentFragment();
            records.forEach(r => {
                const st = state.db.students.find(s => s.lrn === r.studentId);
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="p-3 border-r border-gray-200">${st ? st.name : 'Unknown'}</td>
                    <td class="p-3 border-r border-gray-200">${filter}</td>
                    <td class="p-3 border-r border-gray-200">${r.subject}</td>
                    <td class="p-3 border-r border-gray-200 font-bold">${r.score}/${r.total}</td>
                    <td class="p-3 text-right text-xs text-slate-500">${new Date(r.date).toLocaleDateString()}</td>
                `;
                frag.appendChild(tr);
            });
            tbody.appendChild(frag);
            renderAnalytics();
        }
        on('filter-records-grade', 'change', renderRecords);
        on('filter-analytics-subject', 'change', renderAnalytics);

        function renderAnalytics() {
            const subject = get('filter-analytics-subject').value;
            const container = get('analytics-container');
            container.innerHTML = '';

            if(!subject) { container.innerHTML = '<div class="text-center text-slate-400 italic mt-8">Please create assessments first.</div>'; return; }

            const relevantGrades = state.db.grades.filter(g => g.subject === subject);
            if(relevantGrades.length === 0) { container.innerHTML = `<div class="text-center text-slate-400 italic mt-8">No results for ${subject}.</div>`; return; }

            const stats = {};
            relevantGrades.forEach(g => {
                const stName = state.db.students.find(s => s.lrn === g.studentId)?.name || "Unknown";
                if(g.details && g.details.questions) {
                    g.details.questions.forEach(q => {
                        if(!stats[q.text]) stats[q.text] = { text: q.text, correct: 0, wrong: 0, correctSt: [], wrongSt: [] };
                        const studentAns = g.details.answers[q.id];
                        if(studentAns === q.correct) {
                            stats[q.text].correct++;
                            stats[q.text].correctSt.push(stName);
                        } else {
                            stats[q.text].wrong++;
                            stats[q.text].wrongSt.push(stName);
                        }
                    });
                }
            });

            const frag = document.createDocumentFragment();
            Object.values(stats).forEach((stat, i) => {
                const total = stat.correct + stat.wrong;
                const pct = Math.round((stat.correct / total) * 100);
                const div = document.createElement('div');
                div.className = "border border-gray-200 rounded p-4";
                div.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <div class="font-bold text-slate-700 w-3/4"><span class="text-blue-600 mr-2">Q${i+1}.</span> ${stat.text}</div>
                            <div class="text-right"><div class="text-2xl font-bold ${pct >= 75 ? 'text-green-600' : 'text-red-600'}">${pct}%</div></div>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2 mb-3"><div class="bg-blue-600 h-2 rounded-full" style="width: ${pct}%"></div></div>
                        <details class="text-xs"><summary class="cursor-pointer text-slate-500">Breakdown</summary>
                            <div class="grid grid-cols-2 gap-4 mt-2 bg-slate-50 p-2">
                                <div><div class="text-green-700 font-bold">Correct</div>${stat.correctSt.join(', ')}</div>
                                <div><div class="text-red-700 font-bold">Wrong</div>${stat.wrongSt.join(', ')}</div>
                            </div>
                        </details>`;
                frag.appendChild(div);
            });
            container.appendChild(frag);
        }

        // E. SETTINGS
        on('do-save-profile', 'click', async () => {
            state.db.profile = { name: get('set-name').value, grade: get('set-grade').value, subject: get('set-subject').value };
            saveDB();
            alert("Settings Saved");
            renderDashboard();
        });
        on('do-reset-year', 'click', async () => {
            if(confirm("Resetting deletes ALL student data.")) {
                state.db.students = []; state.db.grades = [];
                saveDB();
                location.reload();
            }
        });

        // 6. STUDENT LOGIC
        function renderStudentDashboard() {
            const tbody = get('student-results-table');
            tbody.innerHTML = '';
            const myGrades = state.db.grades.filter(g => g.studentId === state.user.lrn).sort((a,b) => new Date(b.date) - new Date(a.date));
            if(myGrades.length > 0) hide('student-no-results'); else show('student-no-results');

            const frag = document.createDocumentFragment();
            myGrades.forEach((g, i) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="p-4 font-bold text-slate-700">${g.subject}</td>
                    <td class="p-4">${g.score}/${g.total}</td>
                    <td class="p-4 text-xs text-slate-500">${new Date(g.date).toLocaleDateString()}</td>
                    <td class="p-4 text-right"><button class="bg-white border border-gray-300 text-slate-600 px-3 py-1 rounded text-xs hover:bg-slate-50 font-bold btn-review">Review</button></td>
                `;
                tr.querySelector('.btn-review').addEventListener('click', () => openReview(i));
                frag.appendChild(tr);
            });
            tbody.appendChild(frag);
            
            // Refresh dropdown to respect section
            updateSelects(); 
        }

        function openReview(index) {
            const myGrades = state.db.grades.filter(g => g.studentId === state.user.lrn).sort((a,b) => new Date(b.date) - new Date(a.date));
            const g = myGrades[index];
            const cont = get('review-container');
            cont.innerHTML = '';
            const frag = document.createDocumentFragment();
            g.details.questions.forEach((q, idx) => {
                const userAns = g.details.answers[q.id];
                const isCorrect = userAns === q.correct;
                const div = document.createElement('div');
                div.className = `border ${isCorrect ? 'border-green-200 bg-green-50' : 'border-red-200 bg-red-50'} rounded p-4`;
                div.innerHTML = `
                        <div class="flex justify-between mb-2"><span class="font-bold text-slate-700">Q${idx+1}</span><span class="text-xs font-bold ${isCorrect?'text-green-700':'text-red-700'}">${isCorrect?'Correct':'Incorrect'}</span></div>
                        <p class="mb-3 text-sm text-slate-800">${q.text}</p>
                        <div class="text-xs">Your Answer: <b>${userAns}</b> ${!isCorrect ? `| Correct: <b>${q.correct}</b>` : ''}</div>
                    `;
                frag.appendChild(div);
            });
            cont.appendChild(frag);
            setView('view-student-review');
        }

        on('do-start-exam', 'click', () => {
            const subject = get('st-course').value;
            
            // CHECK FOR EXISTING ATTEMPT
            const alreadyTaken = state.db.grades.some(g => g.studentId === state.user.lrn && g.subject === subject);
            if (alreadyTaken) {
                return alert("You have already submitted this assessment. You cannot retake it.");
            }

            // FILTER: Must match Subject AND Student's Section details (Grade/Quarter)
            const stSection = state.db.courses.find(c => c.name === state.user.course);
            if (!stSection) return alert("Error: Your section data is missing.");

            const questions = state.db.questions.filter(q => 
                q.subject === subject && 
                q.grade === stSection.grade && 
                q.quarter === stSection.quarter
            );

            if(questions.length === 0) return alert(`No questions available for ${subject} in ${stSection.grade} - ${stSection.quarter}`);
            
            state.session = { subject, questions: questions.sort(() => 0.5 - Math.random()), answers: {}, idx: 0, startTime: Date.now() };
            setTxt('exam-tag', subject);
            renderExamQ();
            setView('view-exam');
            startTimer();
        });

        function renderExamQ() {
            const q = state.session.questions[state.session.idx];
            setTxt('exam-progress', `Q ${state.session.idx + 1} of ${state.session.questions.length}`);
            get('exam-q-text').innerText = q.text;
            const passEl = get('exam-passage');
            if(q.passage && q.passage.length > 5) { passEl.innerText = q.passage; passEl.classList.remove('hidden'); } else passEl.classList.add('hidden');
            
            const optsDiv = get('exam-opts');
            optsDiv.innerHTML = '';
            const frag = document.createDocumentFragment();
            ['A','B','C','D'].forEach(key => {
                if(q.opts[key]) {
                    const isSelected = state.session.answers[q.id] === key;
                    const lbl = document.createElement('label');
                    lbl.className = `flex items-center gap-3 p-3 border rounded cursor-pointer transition ${isSelected ? 'bg-blue-50 border-blue-500 ring-1 ring-blue-500' : 'hover:bg-gray-50 border-gray-200'}`;
                    lbl.innerHTML = `<input type="radio" name="exam_opt" value="${key}" class="hidden" ${isSelected?'checked':''}><span class="w-6 h-6 rounded-full bg-white border border-gray-300 flex items-center justify-center text-xs font-bold text-slate-500 shadow-sm ${isSelected?'bg-blue-500 text-white border-blue-500':''}">${key}</span><span class="text-slate-700">${q.opts[key]}</span>`;
                    lbl.querySelector('input').addEventListener('change', () => { state.session.answers[q.id] = key; renderExamQ(); });
                    frag.appendChild(lbl);
                }
            });
            optsDiv.appendChild(frag);

            get('question-grid').innerHTML = state.session.questions.map((q, i) => `<button class="w-8 h-8 rounded text-xs font-bold ${state.session.answers[q.id] ? 'bg-blue-600 text-white' : (i===state.session.idx ? 'bg-blue-100 text-blue-700 ring-2 ring-blue-400' : 'bg-white border border-gray-300')}">${i+1}</button>`).join('');
            const gridBtns = get('question-grid').querySelectorAll('button');
            gridBtns.forEach((btn, i) => btn.addEventListener('click', () => { state.session.idx = i; renderExamQ(); }));
        }

        on('do-next-q', 'click', () => { if(state.session.idx < state.session.questions.length - 1) { state.session.idx++; renderExamQ(); } });

        let timerInt;
        function startTimer() {
            clearInterval(timerInt);
            timerInt = setInterval(() => {
                const elapsed = Math.floor((Date.now() - state.session.startTime) / 1000);
                setTxt('timer', `${Math.floor(elapsed/60).toString().padStart(2,'0')}:${(elapsed%60).toString().padStart(2,'0')}`);
            }, 1000);
        }

        on('do-exit-exam', 'click', async () => {
            if(confirm("Submit assessment?")) {
                clearInterval(timerInt);
                let score = 0;
                state.session.questions.forEach(q => { if(state.session.answers[q.id] === q.correct) score++; });
                
                const newGrade = {
                    studentId: state.user.lrn,
                    subject: state.session.subject,
                    score, total: state.session.questions.length,
                    date: new Date().toISOString(),
                    details: { questions: state.session.questions, answers: state.session.answers }
                };

                // Local update for immediate UI feedback
                state.db.grades.push(newGrade);
                
                // Cloud Sync Logic for Student
                if (state.user?.role === 'student' && state.user?.teacherUid) {
                    try {
                        // Fetch latest to avoid overwriting teacher's changes
                        const teacherRef = doc(db, 'artifacts', APP_ID, 'users', state.user.teacherUid);
                        const latestSnap = await getDoc(teacherRef);
                        if (latestSnap.exists()) {
                            const latestData = latestSnap.data().data;
                            latestData.grades.push(newGrade); // Append to fresh data
                            await setDoc(teacherRef, { data: latestData }); // Save back
                        }
                    } catch(e) { console.error("Grade sync error", e); }
                } else {
                    // Teacher flow or local fallback
                    await saveDB();
                }

                alert(`You scored ${score}/${state.session.questions.length}`);
                setView('view-student-dashboard');
                renderStudentDashboard();
            }
        });

        // INIT
        window.addEventListener('load', () => { setView('view-landing'); console.log("System Ready"); });
    </script>
</body>
</html>
